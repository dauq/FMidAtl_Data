<!DOCTYPE html>

<html lang="en">
  <head>
	<meta charset="UTF-8" />

    <title>MAR Teams and Events</title>

    <script type="text/javascript" src="./jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="./jquery-ui.js"></script>
    <link rel="stylesheet" href="./jquery-ui.css">

    <script type="text/javascript" src="./jquery-ui-slider-pips.js"></script>
    <link rel="stylesheet" href="./jquery-ui-slider-pips.css">

    <!-- DataTables -->
    <script type="text/javascript" charset="utf8"src="./jquery.dataTables.js"></script>
    <link rel="stylesheet" type="text/css" href="./jquery.dataTables.css">

  <style>
    body { font-family: Open Sans, sans-serif; }

    #map-group  { padding-top: 20px; }
    #map-canvas { width:800px; height:600px; float: left; }
	#mapSidebar { float: left; }
    #legend { }

    .layer-wizard-search-label { font-family: sans-serif; }
	
    #searchTeam    { padding-top: 20px; }
    #searchPlace   { padding-top: 20px; }
    #toggle-layers { padding-top: 20px; }

    #sliderGrp { padding: 20px 10px 10px 10px; }
    .ui-slider-horizontal {
      height: 10px;
      width: 200px;
    }

    #chart { padding-top: 20px; clear: left; float:left; }
    #teams { padding-top: 20px; float: left; }
	#registration { padding-top: 20px; width: 80%; margin: 0% 10% 0% 10%; clear: left; }
    #ft-teamdata     { padding-top: 20px; width: 80%; margin: 0% 10% 0% 10%; clear: left; }
    #ft-eventdata    { padding-top: 20px; width: 70%; margin: 0% 15% 0% 15%; clear: left; }
    #ft-eventdataoff { padding-top: 20px; width: 70%; margin: 0% 15% 0% 15%; }
    #ft-eventdataall { padding-top: 20px; width: 80%; margin: 0% 10% 0% 10%; }

  </style>

  <script type="text/javascript" src="https://www.google.com/jsapi"></script>
  <script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false"></script>

  <script type="text/javascript">
    google.load('visualization', '1');

    var map;
    var geocoder;
	var docidDistricts = "17fvVOY1Koa8FwmR6q8Hynsd36YyWqdqPnltm35CA" ;
	var docidEvents    = "1InCtRQ9WSBAxHNLCra2QpLDlgDW706mjwM9MWIJC" ;
	var docidTeams     = "15CHtZQwn8Swu4oMiJvWuIPM-6FHCKWFmFQPkpVpN" ;
    var layerDistricts;
    var layerEvents;
    var layerTeams;
    var defaultCenter = new google.maps.LatLng(40.59367790359577, -75.16438677343753);
    var defaultZoom = 8;

    function initialize() {

      geocoder = new google.maps.Geocoder();
      map = new google.maps.Map(document.getElementById('map-canvas'), {
        center: defaultCenter,
        zoom: defaultZoom
      });
      var style = [
        {
          featureType: 'transit',
          elementType: 'all',
          stylers: [
            { visibility: 'off' }
          ]
        }
      ];
      var styledMapType = new google.maps.StyledMapType(style, {
        map: map,
        name: 'Styled Map'
      });
      map.mapTypes.set('map-style', styledMapType);
      map.setMapTypeId('map-style');

      layerDistricts = new google.maps.FusionTablesLayer({
        query: {
          select: "'geometry'",
          from: docidDistricts,
          where: " 'Inaugural Year' <= '2015'"
        },
        map: map,
//        suppressInfoWindows: true,
        styleId: 2,
        templateId: 2
      });

      layerTeams = new google.maps.FusionTablesLayer({
        query: {
          select: "lat/long",
          from: docidTeams,
          where: " '2015' = 'Y'"
        },
        styles: [{
          where: " 'Rookie Yr' = '2015'",
          markerOptions: { iconName: "large_green" }
        }],
        map: map,
        styleId: 2,
        templateId: 2
      });

      layerEvents = new google.maps.FusionTablesLayer({
        query: {
          select: "Address",
          from: docidEvents,
          where: " Year = '2015'"
        },
        map: map,
        styleId: 2,
        templateId: 2
      });

    loadFTable();
    loadEventFTable("year", 2015, "eventTable", "ft-eventdata");
    loadEventFTable("off", 2015, "eventTableOff", "ft-eventdataoff");
	loadEventFTable("all", 2015, "eventTableAll", "ft-eventdataall");

    } // initialize

    function zoomTeamMap() {

      var whereClause = "";
      var searchString = document.getElementById('search-string_1').value.replace(/'/g, "\\'").trim();

      if (searchString == '') {
        resetMap();
      }
      else {
        var query = "SELECT 'lat/long' " +
            "FROM " + docidTeams +
            " WHERE 'Team' = '" + searchString + "'";
        var queryText = encodeURIComponent(query);
        var gvizQuery = new google.visualization.Query(
            'https://www.google.com/fusiontables/gvizdata?tq='  + queryText);

        gvizQuery.send(function(response) {
          var rowValue = response.getDataTable().getValue(0, 0);
          map.panTo({ lat: parseFloat(rowValue.slice(0,rowValue.search(","))),
		      lng: parseFloat(rowValue.slice(rowValue.search(",")+1)) });
          map.setZoom(12);
        })
      }
    } // zoomTeamMap
	
	function zoomTeamMap2(team) {

      var whereClause = "";
      var searchString = team;
	  
	  document.getElementById('search-string_1').value = team;

      if (searchString == '') {
        resetMap();
      }
      else {
        var query = "SELECT 'lat/long' " +
            "FROM " + docidTeams +
            " WHERE 'Team' = '" + searchString + "'";
        var queryText = encodeURIComponent(query);
        var gvizQuery = new google.visualization.Query(
            'https://www.google.com/fusiontables/gvizdata?tq='  + queryText);

        gvizQuery.send(function(response) {
          var rowValue = response.getDataTable().getValue(0, 0);
          map.panTo({ lat: parseFloat(rowValue.slice(0,rowValue.search(","))),
		      lng: parseFloat(rowValue.slice(rowValue.search(",")+1)) });
          map.setZoom(12);
        })
      }
	  return true;
    } // zoomTeamMap2

    function zoomToAddress() {
      var address = document.getElementById('address').value.trim();
      if (address != '') {
        geocoder.geocode({ address: address }, 
          function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
              map.panTo(results[0].geometry.location);
              map.setZoom(12);
            } else {
              window.alert('Address could not be geocoded: ' + status);
            }
          }
        );
      }
    }

    function resetMap() {
      map.panTo(defaultCenter);
      map.setZoom(defaultZoom);
	  layerDistricts.setMap(map);
      layerTeams.setMap(map);
      layerEvents.setMap(map);
	  document.getElementById("checkDistrict").checked = true;
	  document.getElementById("checkTeam").checked = true;
	  document.getElementById("checkEvent").checked = true;
    }

$('#search-string_1').keypress(function(event){
    var keycode = (event.keyCode ? event.keyCode : event.which);
    if(keycode == '13'){
        zoomTeamMap();
    }
});

    function changeMap(layerNum) {
      if (layerNum == 0) {
        toggleLayer(layerEvents);
      }
      if (layerNum == 1) {
        toggleLayer(layerTeams);
        // so event markers stay on top
        toggleLayer(layerEvents); toggleLayer(layerEvents);
      }
	  if (layerNum == 2) {
	    toggleLayer(layerDistricts);
		toggleLayer(layerTeams); toggleLayer(layerTeams);
		toggleLayer(layerEvents); toggleLayer(layerEvents);
	  }
    } // changeMap

    function toggleLayer(layer) {
      var layerMap = layer.getMap();

      if (layerMap) {
        layer.setMap(null);
      } else {
        layer.setMap(map);
      }
    } // toggleLayer

	function changeDistrictYr(yr) {
      layerDistricts.setOptions({
        query: {
          select: "'geometry'",
          from: docidDistricts,
          where: " 'Inaugural Year' <= '" + yr + "'"
        }
      });
    }

    function changeEventYr(yr) {
      layerEvents.setOptions({
        query: {
          select: "Address",
          from: docidEvents,
          where: " Year = '" + yr + "'"
        }
      });
    }

    function changeTeamYr(yr) {
      var tmp;
      if (yr == 2016) { tmp = 2015; } else { tmp = yr; }
      layerTeams.setOptions({
        query: {
          select: "lat/long",
          from: docidTeams,
          where: " '" + tmp + "' = 'Y'"
        },
        styles: [{
          where: "'Rookie Yr' = '" + tmp + "'",
          markerOptions: { iconName: "large_green" }
//          }, {
//          where: "'Rookie Yr' <= '" + tmp + "'",
//          markerOptions: { iconName: "large_yellow" }
        }]
      });
    }


    function loadFTable() {
      // Construct query
      var query = "SELECT 'Team', 'Nickname' as 'Name', 'Rookie Yr', 'Latest Yr', 'state' as 'State', 'Location' " +
            "FROM " + docidTeams;
      var queryText = encodeURIComponent(query);
      var gvizQuery = new google.visualization.Query(
          'https://www.google.com/fusiontables/gvizdata?tq=' + queryText);

      gvizQuery.send(function(response) {
        var numRows = response.getDataTable().getNumberOfRows();
        var numCols = response.getDataTable().getNumberOfColumns();

        var ftdata = [];
        // ftdata.push('<table id="teamTable" class="tablesorter" >');
        ftdata.push('<table id="teamTable" class="display" cellspacing="0" cellpadding="0" border="0">');
        ftdata.push('<caption>List of All MAR Teams since 2012 (hold SHIFT to sort by >1 column)</caption>');
	    ftdata.push('<thead><tr>');
        for (var i = 0; i < numCols; i++) {
          var columnTitle = response.getDataTable().getColumnLabel(i);
          ftdata.push('<th>' + columnTitle + '</th>');
        }
		ftdata.push('<th> Web Links </th>');
        ftdata.push('</tr></thead><tbody>');

        for (var i = 0; i < numRows; i++) {
          ftdata.push('<tr>');
          for(var j = 0; j < numCols; j++) {
            var rowValue = response.getDataTable().getValue(i, j);
            ftdata.push('<td>' + rowValue + '</td>');
          }
		  
		  ftdata.push('<td>' +
		    '<a href="http://frclinks.frclinks.com/t/' + response.getDataTable().getValue(i, 0) + '" target="_blank">FIRST</a> ' +
		    '<a href="http://www.thebluealliance.com/team/' + response.getDataTable().getValue(i, 0) + '" target="_blank">TBA</a> ' +
			'<a href="http://frclinks.frclinks.com/w/' + response.getDataTable().getValue(i, 0) + '" target="_blank">Team</a> ' +
			'<a href="#" onclick="zoomTeamMap2(' + response.getDataTable().getValue(i, 0) + ')">Map</a></td>');
          ftdata.push('</tr>');
        }
        ftdata.push('</tbody></table>');
        document.getElementById('ft-teamdata').innerHTML = ftdata.join('');

        $('#teamTable').DataTable({
            "scrollY":        "500px",
            "scrollCollapse": true,
            "paging":         false,
            "columns": [
              { "width":  "5%", className: "dt-center" },
              null,
              { "width": "10%", className: "dt-center" },
			  { "width": "10%", className: "dt-center" },
              { "width":  "5%", className: "dt-center" },
              null,
			  { "width": "20%", className: "dt-center" }
            ]
        });

      });

    } // loadFTable
	
	function recalcTable() {
	  // Fix column header width calc so they align with cols when window is resized
	  $('#teamTable').DataTable().draw();
	  $('#eventTableAll').DataTable().draw();

	}

    function loadEventFTable(type, year, tableid, divid) {
	  var captionTitle;
	  var colTitle;
	  var whereClause = "";
	  var selectClause = "";
	  if (type == "all") {
	    captionTitle = "List of all Events";
		colTitle = "Week/Date";
		selectClause = "'Year', " ;
	  } else if (type == "off") {
	    captionTitle = "List of " + year + " Off-Season Events";
		colTitle = "Date";
		whereClause = "WHERE 'Type' IN " + "('0')" + " AND 'Year' = '" + year + "'";
	  } else {
	    captionTitle = "List of " + year + " MAR Events";
		colTitle = "Week";
		whereClause = "WHERE 'Type' IN " + "('1', '1')" + " AND 'Year' = '" + year + "'";
	  }
      // Construct query
      var query = "SELECT " + selectClause + "'Week' as '" + colTitle + "', 'Event', 'Location' as 'Venue', 'Address' " +
            "FROM " + docidEvents + " " +
			whereClause;
      var queryText = encodeURIComponent(query);
      var gvizQuery = new google.visualization.Query(
          'https://www.google.com/fusiontables/gvizdata?tq=' + queryText);

      gvizQuery.send(function(response) {
        var numRows = response.getDataTable().getNumberOfRows();
        var numCols = response.getDataTable().getNumberOfColumns();

        var ftdata = [];
        ftdata.push('<table id="' + tableid + '" class="display" cellspacing="0">');
        ftdata.push('<caption>' + captionTitle + '</caption>');
	    ftdata.push('<thead><tr>');
        for (var i = 0; i < numCols; i++) {
          var columnTitle = response.getDataTable().getColumnLabel(i);
          ftdata.push('<th>' + columnTitle + '</th>');
        }
        ftdata.push('</tr></thead><tbody>');

        for (var i = 0; i < numRows; i++) {
          ftdata.push('<tr>');
          for(var j = 0; j < numCols; j++) {
            var rowValue = response.getDataTable().getValue(i, j);
            ftdata.push('<td>' + rowValue + '</td>');
          }
          ftdata.push('</tr>');
        }
        ftdata.push('</tbody></table>');
        document.getElementById(divid).innerHTML = ftdata.join('');

		if (type == "all") {
          $('#' + tableid).DataTable({
            "scrollY":        "500px",
            "scrollCollapse": true,
            "paging":         false,
			"order": [[0, 'asc'], [1, 'asc']],
			"columns": [
              { "width": "10%", className: "dt-center", },
              { "width": "10%", className: "dt-center" },
              null,
			  null,
		      null
            ]
          });
		} else {
		  $('#' + tableid).DataTable({
              "paging":    false,
              "info":      false,
              "searching": false,
			  "columns": [
                { className: "dt-center" },
                null,
                null,
			    null
              ]
          });
		}

      });

    } // loadEventFTable

    google.maps.event.addDomListener(window, 'load', initialize);

  $(function() {
    $( "#sliderYr" ).slider({
      value: 2015,
      min:   2012,
      max:   2016,
      step:  1,
      slide: function( event, ui ) {
        $( "#currentYr" ).val( ui.value );
		changeDistrictYr(ui.value);
        changeTeamYr(ui.value);
        changeEventYr(ui.value);
		event.stopPropagation();
		loadEventFTable("year", ui.value, "eventTable", "ft-eventdata");
        loadEventFTable("off", ui.value, "eventTableOff", "ft-eventdataoff");
      }
    });
    $( "#currentYr" ).val( $( "#sliderYr" ).slider( "value" ) );
    $( "#sliderYr" ).slider().slider( "pips" ).slider( "float" );
  });

 /** 
  function httpGet(theUrl)
  {
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open( "GET", theUrl, false );
    xmlHttp.send( null );
    return xmlHttp.responseText;
  }
  console.log("Getting");
  console.log(httpGet("https://www.googleapis.com/fusiontables/v2/tables/1tVMaJGvsi9EKTpkXa5uKp5gKsjruNM-wXoY_4quq/styles&key=AIzaSyBqD0By8tSyEg0KEuEVvwhxokH1Yyzl7o4"));
  **/
  
  </script>

  </head>

  <body onresize="recalcTable()">
    <div id="page-header"><h1>MAR Teams and Events</h1></div>
	
	<div id="registration">2016 MAR Registration<br>
	   <iframe width = "1080" height = "720" frameborder = "2"
	      src="https://docs.google.com/spreadsheets/d/1zAwyrXzczlXM-PMHJNzh1pFwou8MkM3kcfnIiXwmrEk/pubhtml?widget=true&amp;headers=false">
	   </iframe>
	</div>
	<br><br>
    <div id="map-group">

      <div id="map-canvas"></div>
	  <div id="mapSidebar">
        <div id="legend">
          <img style="vertical-align:middle" src="https://maps.google.com/mapfiles/ms/micons/yellow-dot.png">&#8211 Veteran Team
          <br>
          <img style="vertical-align:middle" src="https://maps.google.com/mapfiles/ms/micons/green-dot.png">&#8211 Rookie Team
          <br>
          <img style="vertical-align:middle" src="https://maps.google.com/mapfiles/ms/micons/purple-dot.png">&#8211 District Event
          <br>
          <img style="vertical-align:middle" src="https://maps.google.com/mapfiles/ms/micons/red-dot.png">&#8211 MAR Championship
          <br>
          <img style="vertical-align:middle; padding: 0 12px 0 12px" src="https://maps.gstatic.com/intl/en_ALL/mapfiles/markers2/measle.png">&#8211 Off-Season Event
        </div>

        <div id="searchTeam">
          <label class="layer-wizard-search-label">
            Team Number
            <input type="text" size="4" id="search-string_1">
            <input type="button" onclick="zoomTeamMap()" value="Zoom">
          </label> 
        </div>

        <div id="searchPlace">
          <label>Zoom to address/zip code/city,state:</label>
          <br>
          <input type="text" size="15" id="address" value="Bethlehelm, PA">
          <input type="button" onclick="zoomToAddress()" id="search" value="Zoom">
          <br><br>
          <input type="button" onclick="resetMap()"id="reset" value="Reset Map">
        </div>

        <div id="toggle-layers">
          <label>Show Layers:</label>
          <br>
          <input id="checkDistrict" type="checkbox" value="2" onclick="changeMap(this.value)" checked="checked" />Show Districts
          <br>
          <input id="checkEvent" type="checkbox" value="0" onclick="changeMap(this.value)" checked="checked" />Show Events
          <br>
          <input id="checkTeam" type="checkbox" value="1" onclick="changeMap(this.value)" checked="checked" />Show Teams
        </div>

        <div id="sliderGrp">
          <div id="sliderYr" ></div>
<!--
        <label for="currentYr">Year:</label>
        <input type="text" id="currentYr" readonly style="border:0; font-weight:bold;">
-->
        </div>
	  </div>
    </div>

	<div id="ft-eventdata"></div>
    <div id="ft-eventdataoff"></div>
    
    <div id="chart">MAR events from 2012-2016<br>
    <img src="./MAR-events-by-year.jpg" alt="MAR events chart">
    <br>note: 2016 is tentative</div>

    <div id="teams">MAR Teams from 2012-1015<br>
      <iframe width = "650" height = "720" frameborder = "0"
 	    src='https://docs.google.com/spreadsheets/d/19YkFYvHZqHM6M2zk_QfOIvPpLao1E1z-oPxJMylPgE8/pubhtml?gid=1990421387&single=true&widget=false&chrome=false'>
      </iframe>
    </div>
	
    <div id="ft-teamdata"></div>
	<div id="ft-eventdataall"></div>

  </body>
</html>


 
